{% extends "core/base.html" %}
{% load static %}

{% block title %}Gestion des Classes et Élèves{% endblock %}

{% block head_extra %}
{{ block.super }}
{# Chemin vers le CSS général du dashboard #}
<link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}">
{# Chemin vers le CSS spécifique à cette page #}
<link rel="stylesheet" href="{% static 'dashboard/class_management.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-users-cog"></i> Gestion des Classes et Élèves</h1>
    <p>Créez des classes, ajoutez des élèves et organisez vos groupes.</p>
</div>

<div class="management-actions">
    <button id="addClassBtn" class="validate-btn"><i class="fas fa-plus"></i> Créer une classe</button>
    <button id="addStudentBtn" class="validate-btn secondary"><i class="fas fa-user-plus"></i> Ajouter un élève</button>
</div>

<div class="management-grid">
    <!-- Colonne pour les classes existantes -->
    {% for class in classes %}
    <div class="class-card" data-class-id="{{ class.id }}">
        <div class="class-header">
            <h3 class="class-name">{{ class.name }}</h3>
            <div class="class-actions">
                <button class="icon-btn rename-class-btn" title="Renommer"><i class="fas fa-pen"></i></button>
                <button class="icon-btn delete-class-btn" title="Supprimer"><i class="fas fa-trash"></i></button>
            </div>
        </div>
        <ul class="student-list">
            {% for student in class.user_set.all %}
            <li class="student-item" data-student-id="{{ student.id }}">
                <span><i class="fas fa-user"></i> {{ student.username }}</span>
                <div class="student-actions">
                    <button class="icon-btn move-student-btn" title="Déplacer"><i class="fas fa-random"></i></button>
                    <button class="icon-btn delete-student-btn" title="Supprimer"><i class="fas fa-user-minus"></i></button>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}

    <!-- Colonne pour les élèves non assignés -->
    <div class="class-card unassigned" data-class-id="">
        <div class="class-header">
            <h3><i class="fas fa-question-circle"></i> Élèves non assignés</h3>
        </div>
        <ul class="student-list">
            {% for student in unassigned_students %}
            <li class="student-item" data-student-id="{{ student.id }}">
                <span><i class="fas fa-user"></i> {{ student.username }}</span>
                <div class="student-actions">
                    <button class="icon-btn move-student-btn" title="Déplacer"><i class="fas fa-random"></i></button>
                    <button class="icon-btn delete-student-btn" title="Supprimer"><i class="fas fa-user-minus"></i></button>
                </div>
            </li>
            {% empty %}
            <li class="empty-list">Aucun élève non assigné.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Modale pour ajouter/déplacer un élève -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="studentModalTitle">Ajouter un élève</h2>
        <form id="studentForm">
            <div class="form-group">
                <label for="username">Nom d'utilisateur</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Mot de passe (provisoire)</label>
                <input type="text" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="studentClass">Assigner à la classe</label>
                <select id="studentClass" name="class_id">
                    <option value="">Non assigné</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}">{{ class.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="validate-btn">Enregistrer</button>
        </form>
    </div>
</div>

<!-- Modale pour déplacer un élève -->
<div id="moveStudentModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Déplacer l'élève <span id="moveStudentName"></span></h2>
        <form id="moveStudentForm">
            <input type="hidden" id="moveStudentId" name="student_id">
            <div class="form-group">
                <label for="targetClass">Nouvelle classe</label>
                <select id="targetClass" name="target_class_id">
                    <option value="">Non assigné</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}">{{ class.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="validate-btn">Déplacer</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    // URLs pour les appels API
    const classCreateUrl = "{% url 'dashboard:class-create' %}";
    const classActionUrlTemplate = "{% url 'dashboard:class-action' 0 %}".replace('0', ''); // Template /api/classes/ID/action/
    const studentCreateUrl = "{% url 'dashboard:student-create' %}";
    const studentActionUrlTemplate = "{% url 'dashboard:student-action' 0 %}".replace('0', ''); // Template /api/students/ID/action/
    const csrfToken = "{{ csrf_token }}";
</script>
{# Chemin vers le JavaScript spécifique à cette page #}
<script src="{% static 'dashboard/class_management.js' %}"></script>
{% endblock %}

