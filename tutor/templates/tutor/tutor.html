{% extends "core/base.html" %}
{% load static %}

{% block title %}Tuteur IA - Catalyst{% endblock %}

{% block head_extra %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://unpkg.com/perfect-freehand@1.2.0/dist/perfect-freehand.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'tutor/tutor.css' %}">
    <style>
        #hintBtn {
            font-size: 1.5rem;
            padding: 0 15px;
            background-color: #ffc107; /* Jaune pour l'idÃ©e */
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px; /* Espace entre le bouton indice et la zone de texte */
        }
        #hintBtn:hover {
            background-color: #ffca2c;
        }
        #hintBtn:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        /* RÃ©duire la taille initiale du whiteboard */
        .whiteboard-workspace {
            flex-grow: 1; /* Permet au chat de prendre plus de place */
            min-height: 350px; /* Hauteur minimale pour le dessin */
        }
        .input-area {
            flex-shrink: 0; /* EmpÃªche la zone de saisie de rÃ©trÃ©cir */
        }

        /* Styles pour le mode plein Ã©cran */
        .whiteboard-workspace.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            background-color: var(--bg-color);
            padding: 1rem;
            margin: 0;
            border-radius: 0;
        }
        /* EmpÃªche le scroll de la page quand le whiteboard est en plein Ã©cran */
        body.no-scroll {
            overflow: hidden;
            /* EmpÃªche le "bounce" sur iOS/iPadOS */
            position: fixed; 
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<div class="tutor-container">
  
    <div id="welcomeScreen" {% if ongoing_session %}class="hidden"{% endif %}>
        <div class="welcome-box">
            <h1>ðŸ§® Tuteur en MathÃ©matiques</h1>
            <p>Pour commencer, choisis un document d'exercices.</p>
            <div id="documentSelection" class="file-upload">
                <select id="documentSelector" class="file-label">
                    <option value="">-- Choisir un document --</option>
                    {% for doc in documents %}
                        <option value="{{ doc.file.url }}">{{ doc.title }}</option>
                    {% endfor %}
                </select>
                <button id="startExerciseBtn" class="validate-btn" onclick="startExercise()" disabled>
                    <i class="fas fa-play"></i> Commencer
                </button>
            </div>
        </div>
    </div>

    <main id="workspace" {% if not ongoing_session %}class="hidden"{% endif %}>
        
        <div class="left-panel">
            <div id="questionCard" class="question-card">
                <div class="card-header">
                    <strong>Question :</strong>
                    <div class="question-zoom-controls">
                        <button id="zoomOutBtn" title="Zoom arriÃ¨re"><i class="fas fa-search-minus"></i></button>
                        <span id="questionZoomPercent">100%</span>
                        <button id="zoomInBtn" title="Zoom avant"><i class="fas fa-search-plus"></i></button>
                        <button id="zoomResetBtn" title="RÃ©initialiser le zoom"><i class="fas fa-expand"></i></button>
                    </div>
                    <button id="changeExerciseBtn" title="Changer d'exercice">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button id="endExerciseBtn" class="end-exercise-btn" title="Terminer l'exercice">
                        <i class="fas fa-flag-checkered"></i>
                        <span>Terminer</span>
                    </button>
                </div>
                <div id="questionImageContainer">
                    <img id="questionImageDisplay" src="" alt="Question de mathÃ©matiques">
                </div>
            </div>
            
            <div class="chat-container">
                <div id="chatbox">
                    </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="whiteboard-workspace">
                <div class="toolbar">
                    <div class="tool-group">
                        <button id="penTool" class="tool active" onclick="setTool('pen')" title="Stylo"><i class="fas fa-pen"></i></button>
                        <button id="eraserTool" class="tool" onclick="setTool('eraser')" title="Gomme"><i class="fas fa-eraser"></i></button>
                    </div>
                    <div class="tool-divider"></div>
                    <div class="tool-group">
                        <input type="color" id="color" value="#000000" title="Couleur">
                    </div>
                    <div class="tool-divider"></div>
                    <div class="tool-group thickness-group">
                        <i class="fas fa-pen-nib"></i>
                        <input type="range" id="size" min="1" max="20" value="3" title="Ã‰paisseur">
                    </div>
                    <div class="tool-divider"></div>
                    <div class="tool-group">
                        <button class="tool" onclick="changeZoom(-0.1)" title="Zoom arriÃ¨re"><i class="fas fa-search-minus"></i></button>
                        <span id="zoomPercent">100%</span>
                        <button class="tool" onclick="changeZoom(0.1)" title="Zoom avant"><i class="fas fa-search-plus"></i></button>
                    </div>
                    <div class="tool-divider"></div>
                    <button id="fullscreenBtn" class="tool" title="Plein Ã©cran"><i class="fas fa-expand-arrows-alt"></i></button>
                    <div class="tool-divider"></div>
                    <button class="tool clear-btn" onclick="clearCanvas()" title="Effacer tout"><i class="fas fa-trash-alt"></i></button>
                </div>
                
                <div class="whiteboard-container" id="whiteboardContainer">
                    <div class="whiteboard-scroll-container" id="scrollContainer">
                        <canvas id="whiteboard"></canvas>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <button id="hintBtn" title="Demander un indice" disabled>ðŸ’¡</button>
                <textarea id="textInput" placeholder="Ã‰cris ta rÃ©ponse ou pose une question..."></textarea>
                <button id="sendBtn" onclick="sendToTutor()" disabled>
                    <span id="sendBtnText">Envoyer</span>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </main>
</div>

<script>
    // URLs for API calls
    const analyzeImageUrl = "{% url 'tutor-analyze-image' %}";
    const endSessionUrl = "{% url 'tutor-end-session' %}";
    const tutorInteractUrl = "{% url 'tutor-interact' %}";
    const csrfToken = "{{ csrf_token }}";

</script>

<!-- DonnÃ©es de session pour JavaScript, dans un format sÃ»r -->
<script id="session-data" type="application/json">
    {
        "ongoing_session": {{ ongoing_session|default:False|yesno:"true,false" }},
        "initial_chat_history": {{ chat_history_json|default:"null"|safe }},
        "exercise_document": {{ exercise_document_json|default:"null"|safe }}
    }
</script>
<script>
   
    const getHintUrl = "{% url 'tutor-get-hint' %}";
</script>


<script src="{% static 'tutor/tutor.js' %}"></script>
{% endblock %}